== Foxdeck - API

This document is intended to provide an insight into the structure of the Foxdeck API. It is intended to be a first entry point for developers who want to implement new functionalities in the API or who want to get an in-depth overview.

=== Security

An interceptor was implemented in NestJS to protect the endpoints of the API.
This interceptor checks every incoming connection to see whether extended authentication is required or not.

The form in which authentication is required or not depends on whether a route has a certain security level.
This is determined with an @Security-Decorator.

==== Usage of the @Security Annotation

The @Security annotation can be used to set which security level is required to call up the route.
There are currently two security levels:

* *NO_SECURE*: No security validation at all, the same as leaving the @Security-Decorator away.
* *JWT_VALID*: Validation of the JWT, which must be a valid JWT.

If the security level "JWT_VALID" has been selected, the JWT in the header is compared with the checksum.
If the JWT is valid, it is parsed and the "User" property is added to the request (see _AuthenticatedRequest_-interface).

===== Example

[source,typescript]
----
@ApiBearerAuth("access-token")
@Security(SecurityType.JWT_VALID)
@HttpCode(HttpStatus.CREATED)
@Post("question")
async createQuestion(
@Body() data: CreateQuestionRequestDto,
@Req() request: AuthenticatedRequest,
): Promise<Question> {
try {
  const user = request.user;
  return this.questionService.createQuestion({
    ...data,
    authorId: user.id,
  });
} catch (e) {
  throw new InternalServerErrorException(e);
}
}
----

==== Usage of the @ApiBearerAuth Annotation

The@ApiBearerAuth("access-token") annotation is used to enable authentication in the Swagger documentation.
After the annotation has been installed, you will find a small lock at the top right of the screen in the Swagger documentation.
Clicking on it opens a dialog in which the authentication token can be entered:

image::assets/api/add-jwt-swagger.png[]

===== Example

The annotation can be used in the code as follows:

[source,typescript]
----
@Controller('example')
export class ExampleController {
  @Get()
  @ApiBearerAuth("access-token")
  getData() {
    // Hier wird ein Bearer-Token im Authorization-Header erwartet.
  }
}
----

==== Generate a JWT for Testing

To generate a JWT, you can use the official website https://jwt.io/:

image::assets/api/generate-jwt.png[]

IMPORTANT: Look into jwt-body.interface.ts to see the current payload the JWT contains.